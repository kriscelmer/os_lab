<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>OpenStack Cloud Catcher</title>
<meta name="description" content="A tiny, single-file JavaScript game themed around OpenStack. Catch services, avoid hazards, get a high score." />
<style>
  :root{
    --bg:#0f1320;
    --bg2:#171c2f;
    --panel:#101526ee;
    --accent:#ff4d67;
    --accent2:#19c2ff;
    --text:#e7ecf3;
    --muted:#98a2b3;
    --good:#2dd36f;
    --bad:#ff4d67;
    --ring:#44506a;
    --shadow: 0 10px 30px rgba(0,0,0,.35);
    --radius:14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background: radial-gradient(1200px 800px at 20% -10%, #1a2240 0%, var(--bg) 45%) fixed;
    color: var(--text); font: 500 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji","Segoe UI Emoji";
    display:flex; flex-direction:column; align-items:center;
  }
  header{
    width:min(1200px, 100%); padding:14px 16px; display:flex; align-items:center; justify-content:space-between;
  }
  h1{font-size:clamp(18px, 2.6vw, 26px); margin:0; letter-spacing:.5px; display:flex; align-items:center; gap:.6rem}
  h1 .badge{
    display:inline-flex; align-items:center; justify-content:center;
    width:28px; height:28px; border-radius:8px; background:linear-gradient(135deg,var(--accent),#ff7f91);
    color:#fff; font-weight:800; box-shadow: var(--shadow);
  }
  .hud{
    display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;
  }
  .pill{
    display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px; background:rgba(255,255,255,.04);
    border:1px solid rgba(255,255,255,.08); color:var(--text); min-height:36px;
  }
  .pill .label{color:var(--muted); font-weight:600; letter-spacing:.3px}
  .btn{
    border:1px solid rgba(255,255,255,.14); background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
    color:var(--text); border-radius:999px; padding:8px 14px; cursor:pointer; font-weight:700; letter-spacing:.3px;
    transition:.15s transform ease, .15s background ease; min-height:36px; box-shadow: 0 6px 14px rgba(0,0,0,.25) inset;
  }
  .btn:hover{transform:translateY(-1px); background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.03))}
  .btn:active{transform:translateY(0)}

  main{width:min(1200px, 100%); padding:6px 16px 20px; display:flex; flex-direction:column; gap:12px; align-items:center; flex:1}
  .stage{
    position:relative; width:100%; aspect-ratio: 16/9; max-height:74vh; background:linear-gradient(180deg, var(--bg2), #0a0d18);
    border:1px solid rgba(255,255,255,.06); border-radius: var(--radius); overflow:hidden; box-shadow: var(--shadow);
  }
  canvas{width:100%; height:100%; display:block; outline:none}
  .overlay{
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center; padding:20px;
    background:linear-gradient(180deg, rgba(10,12,22,.75), rgba(10,12,22,.85)); backdrop-filter: blur(8px);
    color:var(--text);
  }
  .card{
    width:min(780px, 100%); background: var(--panel); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:18px 18px 16px;
    box-shadow: var(--shadow);
  }
  .card h2{margin:8px 0 6px; font-size:22px}
  .grid{display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px}
  .kv{display:flex; align-items:flex-start; gap:10px; background: rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px}
  .kv .dot{width:22px; height:22px; border-radius:6px; display:inline-flex; align-items:center; justify-content:center; font-weight:800}
  .kv small{color:var(--muted)}
  .help{margin-top:10px; color:var(--muted); font-size:14px}
  .muted{color:var(--muted)}
  .hide{display:none}
  footer{color:var(--muted); padding:8px 16px 20px; font-size:14px; width:min(1200px,100%)}
  .toggle{display:inline-flex; gap:8px; align-items:center; cursor:pointer; user-select:none}
  .kbd{font-weight:800; background: rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.18); padding:2px 6px; border-radius:6px}
  .sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0}

  /* Slider styling */
  .pill input[type="range"]{width:120px}
  input[type="range"]{ -webkit-appearance:none; background:transparent; height:22px; }
  input[type="range"]::-webkit-slider-runnable-track{
    height:6px; background:rgba(255,255,255,.15); border-radius:999px; border:1px solid rgba(255,255,255,.12);
  }
  input[type="range"]::-webkit-slider-thumb{
    -webkit-appearance:none; width:16px; height:16px; margin-top:-5px; border-radius:50%;
    background:linear-gradient(135deg, var(--accent2), #77e1ff); border:1px solid rgba(255,255,255,.6); box-shadow: var(--shadow);
    cursor:pointer;
  }
  input[type="range"]::-moz-range-track{
    height:6px; background:rgba(255,255,255,.15); border-radius:999px; border:1px solid rgba(255,255,255,.12);
  }
  input[type="range"]::-moz-range-thumb{
    width:16px; height:16px; border-radius:50%; background:linear-gradient(135deg, var(--accent2), #77e1ff);
    border:1px solid rgba(255,255,255,.6); box-shadow: var(--shadow); cursor:pointer;
  }
</style>
</head>
<body>
  <header>
    <h1 aria-label="OpenStack Cloud Catcher">
      <span class="badge">OS</span> OpenStack Cloud Catcher
    </h1>
    <div class="hud" role="status" aria-live="polite">
      <div class="pill" title="Score"><span class="label">Score</span> <strong id="uiScore">0</strong></div>
      <div class="pill" title="Lives"><span class="label">SLA</span> <strong id="uiLives">❤❤❤</strong></div>
      <div class="pill" title="High Score"><span class="label">Best</span> <strong id="uiBest">0</strong></div>
      <button class="btn" id="btnStart" type="button" title="Start (Space)">Start</button>
      <button class="btn" id="btnPause" type="button" title="Pause (P)">Pause</button>
      <button class="btn" id="btnRestart" type="button" title="Restart (R)">Restart</button>
      <label class="pill toggle" title="Toggle sound (M)">
        <input id="chkSound" type="checkbox" checked />
        <span>Sound</span>
      </label>
      <!-- NEW: Speed control -->
      <div class="pill" id="speedControl" title="Falling speed (%)">
        <span class="label">Speed</span>
        <input type="range" id="speed" min="50" max="200" step="5" aria-label="Falling speed percent" />
        <strong id="uiSpeed">100%</strong>
      </div>
    </div>
  </header>

  <main>
    <div class="stage" id="stage">
      <canvas id="game" tabindex="0" aria-label="Game canvas"></canvas>

      <!-- Intro / Help Overlay -->
      <div id="overlay" class="overlay">
        <div class="card" role="dialog" aria-modal="true" aria-labelledby="introTitle">
          <h2 id="introTitle">Deploy your cloud—catch services, dodge hazards</h2>
          <p>Move your cloud to catch OpenStack services for points and uptime. Avoid hazards that reduce your SLA.</p>
          <div class="grid" aria-label="Legend of items">
            <div class="kv"><span class="dot" style="background:#ff6b6b">N</span>
              <div><strong>Nova</strong><br><small>Compute</small></div></div>
            <div class="kv"><span class="dot" style="background:#4dd0e1">Ne</span>
              <div><strong>Neutron</strong><br><small>Networking</small></div></div>
            <div class="kv"><span class="dot" style="background:#ffd166">Ci</span>
              <div><strong>Cinder</strong><br><small>Block Storage</small></div></div>
            <div class="kv"><span class="dot" style="background:#95d47a">Sw</span>
              <div><strong>Swift</strong><br><small>Object Storage</small></div></div>
            <div class="kv"><span class="dot" style="background:#b388ff">Gl</span>
              <div><strong>Glance</strong><br><small>Images</small></div></div>
            <div class="kv"><span class="dot" style="background:#ff9f43">Ke</span>
              <div><strong>Keystone</strong><br><small>Identity</small></div></div>
            <div class="kv"><span class="dot" style="background:#e53935">!</span>
              <div><strong>Quota Exceeded</strong><br><small>Hazard</small></div></div>
            <div class="kv"><span class="dot" style="background:#fdd835">⚠</span>
              <div><strong>Outage</strong><br><small>Hazard</small></div></div>
          </div>
          <p class="help">
            <span class="kbd">←</span>/<span class="kbd">→</span> or <span class="kbd">A</span>/<span class="kbd">D</span> to move ·
            <span class="kbd">Space</span> start/pause · <span class="kbd">R</span> restart · <span class="kbd">M</span> mute ·
            <span class="kbd">[</span>/<span class="kbd">]</span> speed · <span class="kbd">?</span> help
          </p>
          <button class="btn" id="btnPlay" type="button" aria-label="Play">Play</button>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <small>OpenStack service names are used here for educational flavor in a fan-made demo game. This project is unaffiliated with the OpenInfra Foundation.</small>
  </footer>

<script>
(() => {
  // ---------- Utility ----------
  const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
  const rand = (a,b) => a + Math.random()*(b-a);
  const choice = arr => arr[(Math.random()*arr.length)|0];

  // ---------- Canvas setup (HiDPI aware) ----------
  const canvas = document.getElementById('game');
  const stage  = document.getElementById('stage');
  const ctx = canvas.getContext('2d');

  function resizeCanvas(){
    const rect = stage.getBoundingClientRect();
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    canvas.width = Math.floor(rect.width * dpr);
    canvas.height = Math.floor(rect.height * dpr);
    canvas.style.width = rect.width + 'px';
    canvas.style.height = rect.height + 'px';
    ctx.setTransform(dpr,0,0,dpr,0,0); // Logical units = CSS pixels
  }
  new ResizeObserver(resizeCanvas).observe(stage);
  resizeCanvas();

  // ---------- UI elements ----------
  const uiScore = document.getElementById('uiScore');
  const uiLives = document.getElementById('uiLives');
  const uiBest  = document.getElementById('uiBest');
  const overlay = document.getElementById('overlay');
  const btnStart = document.getElementById('btnStart');
  const btnPause = document.getElementById('btnPause');
  const btnRestart = document.getElementById('btnRestart');
  const btnPlay = document.getElementById('btnPlay');
  const chkSound = document.getElementById('chkSound');
  const speedSlider = document.getElementById('speed');
  const uiSpeed = document.getElementById('uiSpeed');

  // ---------- Audio (tiny beeps, no assets) ----------
  let audioCtx = null, soundOn = true;
  function ensureAudio(){
    if(!audioCtx){ try{ audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }catch(e){ audioCtx = null; } }
  }
  function beep(type='good'){
    if(!soundOn || !audioCtx) return;
    const now = audioCtx.currentTime;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = 'sine';
    o.frequency.value = (type==='good') ? 620 : (type==='bad'? 160 : 380);
    g.gain.setValueAtTime(0.10, now);
    g.gain.exponentialRampToValueAtTime(0.0001, now+0.15);
    o.connect(g).connect(audioCtx.destination);
    o.start(now); o.stop(now+0.15);
  }
  chkSound.addEventListener('change', () => { soundOn = chkSound.checked; if(soundOn) ensureAudio(); });

  // ---------- Game state ----------
  const Services = [
    { key:'Nova',     abbr:'N',  color:'#ff6b6b', info:'Compute'},
    { key:'Neutron',  abbr:'Ne', color:'#4dd0e1', info:'Networking'},
    { key:'Cinder',   abbr:'Ci', color:'#ffd166', info:'Block Storage'},
    { key:'Swift',    abbr:'Sw', color:'#95d47a', info:'Object Storage'},
    { key:'Glance',   abbr:'Gl', color:'#b388ff', info:'Images'},
    { key:'Keystone', abbr:'Ke', color:'#ff9f43', info:'Identity'}
  ];
  const Hazards = [
    { key:'Quota',  abbr:'!',  color:'#e53935', info:'Quota Exceeded'},
    { key:'Outage', abbr:'⚠',  color:'#fdd835', info:'Outage'},
    { key:'NoAuth', abbr:'⛔',  color:'#ef5350', info:'No Auth'}
  ];

  const Game = {
    width: () => canvas.clientWidth,
    height: () => canvas.clientHeight,
    running: false,
    paused: false,
    over: false,
    score: 0,
    lives: 3,
    best: Number(localStorage.getItem('oscatch_best') || 0),
    time: 0,
    spawnTimer: 0,
    spawnEvery: 900, // ms (base interval; will be modulated)
    speedBase: 10,   // px/s for new spawns (base; movement scales with speedFactor), changed from 90 to 10
    items: [],
    particles: [],
    speedFactor: 1,  // global multiplier for falling speed
  };
  uiBest.textContent = Game.best;

  // Initialize speed from storage (default 0.8 = 80%)
  Game.speedFactor = clamp(Number(localStorage.getItem('oscatch_speed')) || 0.8, 0.5, 2.0);
  const initPct = Math.round(Game.speedFactor * 100);
  if (speedSlider) {
    speedSlider.value = String(initPct);
    uiSpeed.textContent = initPct + '%';
  }

  // ---------- Player ----------
  const Player = {
    x: 0, y: 0, w: 120, h: 48, speed: 480, vx:0, targetX: null
  };
  function resetPlayer(){
    Player.w = Math.max(90, Math.min(150, Game.width()*0.12));
    Player.h = Player.w*0.4;
    Player.x = (Game.width()-Player.w)/2;
    Player.y = Game.height()-Player.h-8;
    Player.vx = 0;
    Player.targetX = null;
  }
  resetPlayer();

  // ---------- Items & Particles ----------
  function spawnItem(){
    const isHazard = Math.random() < Math.min(0.22, 0.10 + Game.time*0.0008);
    const pool = isHazard ? Hazards : Services;
    const base = Object.assign({}, choice(pool));
    base.type = isHazard ? 'hazard':'service';
    base.x = rand(30, Game.width()-30);
    base.y = -30;
    base.r = rand(18, 24);
    base.vy = Game.speedBase + Game.time*0.06 + rand(0,40); // base speed; movement scaled by Game.speedFactor
    Game.items.push(base);
  }
  function particleBurst(x,y,color,count=10){
    for(let i=0;i<count;i++){
      Game.particles.push({
        x, y,
        vx: rand(-120,120), vy: rand(-220,-60),
        life: rand(0.3,0.6),
        color
      });
    }
  }

  // ---------- Drawing ----------
  function drawBackground(){
    const w = Game.width(), h = Game.height();
    ctx.save();
    ctx.globalAlpha = 0.18;
    ctx.strokeStyle = '#31405e';
    ctx.lineWidth = 1;
    const step = Math.max(40, Math.min(90, w/16));
    for(let x=0; x<w; x+=step){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke(); }
    for(let y=0; y<h; y+=step){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke(); }
    ctx.restore();

    const grd = ctx.createLinearGradient(0, h*0.6, 0, h);
    grd.addColorStop(0,'rgba(25,35,70,0)');
    grd.addColorStop(1,'rgba(25,35,70,.7)');
    ctx.fillStyle = grd;
    ctx.fillRect(0,h*0.6,w,h*0.4);
  }

  function drawCloud(x,y,w,h){
    ctx.save();
    ctx.translate(x,y);
    ctx.fillStyle = 'rgba(255,255,255,0.92)';
    ctx.strokeStyle = 'rgba(255,255,255,0.95)';
    ctx.lineWidth = 2;
    const r = h/2;
    ctx.beginPath();
    const bw = w, bh = h*0.68, rx = bh/2;
    const by = h-bh;
    roundRect(0, by, bw, bh, rx);
    circle(bw*0.20, by, r);
    circle(bw*0.42, by-h*0.08, r*1.05);
    circle(bw*0.66, by-h*0.05, r*0.95);
    circle(bw*0.86, by, r*0.9);
    ctx.fill(); ctx.stroke();
    ctx.fillStyle = '#1f2a44';
    dot(bw*0.40, by+bh*0.45, 3.5);
    dot(bw*0.60, by+bh*0.45, 3.5);
    ctx.restore();
  }
  function roundRect(x,y,w,h,r){
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r);
    ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r);
    ctx.arcTo(x,y,x+w,y,r);
    ctx.closePath();
  }
  function circle(x,y,r){ ctx.moveTo(x+r,y); ctx.arc(x,y,r,0,Math.PI*2); }
  function dot(x,y,r){ ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); }

  function drawItem(it){
    ctx.save();
    ctx.shadowColor = 'rgba(0,0,0,.35)';
    ctx.shadowBlur = 8;
    ctx.shadowOffsetY = 2;
    ctx.fillStyle = it.color;
    circle(it.x, it.y, it.r);
    ctx.fill();
    ctx.shadowColor = 'transparent';
    ctx.fillStyle = '#0d1326';
    ctx.font = '700 13px system-ui, sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(it.abbr, it.x, it.y);
    ctx.restore();
  }

  function drawParticles(dt){
    for(let i=Game.particles.length-1;i>=0;i--){
      const p = Game.particles[i];
      p.vy += 600*dt;
      p.x += p.vx*dt; p.y += p.vy*dt;
      p.life -= dt;
      if(p.life <= 0) { Game.particles.splice(i,1); continue; }
      ctx.save();
      ctx.globalAlpha = Math.max(0, p.life*1.5);
      ctx.fillStyle = p.color;
      circle(p.x, p.y, 2.5);
      ctx.fill();
      ctx.restore();
    }
  }

  function drawHUD(){
    ctx.save();
    ctx.strokeStyle = 'rgba(255,255,255,0.06)';
    ctx.lineWidth = 2;
    ctx.beginPath(); ctx.moveTo(0, Game.height()-0.5); ctx.lineTo(Game.width(), Game.height()-0.5); ctx.stroke();
    ctx.restore();
  }

  // ---------- Input ----------
  const keys = new Set();
  window.addEventListener('keydown', (e) => {
    if(['ArrowLeft','ArrowRight','a','d','A','D',' ' ,'p','P','r','R','m','M','?','[',']'].includes(e.key))
      e.preventDefault();
    if(e.key===' '){ toggleStartPause(); return; }
    if(e.key==='p' || e.key==='P'){ if(Game.running && !Game.over) togglePause(); return; }
    if(e.key==='r' || e.key==='R'){ restart(); return; }
    if(e.key==='m' || e.key==='M'){ chkSound.checked = !chkSound.checked; chkSound.dispatchEvent(new Event('change')); return; }
    if(e.key==='?'){ showOverlay(true); return; }
    if(e.key==='['){ adjustSpeed(-5); return; }
    if(e.key===']'){ adjustSpeed(+5); return; }
    if(['ArrowLeft','a','A'].includes(e.key)) keys.add('left');
    if(['ArrowRight','d','D'].includes(e.key)) keys.add('right');
  });
  window.addEventListener('keyup', (e) => {
    if(['ArrowLeft','a','A'].includes(e.key)) keys.delete('left');
    if(['ArrowRight','d','D'].includes(e.key)) keys.delete('right');
  });

  function stageXFromEvent(ev){
    const rect = canvas.getBoundingClientRect();
    if(ev.touches && ev.touches[0]) return ev.touches[0].clientX - rect.left;
    return ev.clientX - rect.left;
  }
  canvas.addEventListener('pointermove', (e) => {
    Player.targetX = stageXFromEvent(e) - Player.w/2;
  });
  canvas.addEventListener('pointerdown', () => {
    if(!Game.running || Game.paused || Game.over) toggleStartPause();
    ensureAudio();
  }, {passive:true});
  canvas.addEventListener('touchmove', (e) => {
    Player.targetX = stageXFromEvent(e) - Player.w/2;
  }, {passive:true});

  btnStart.addEventListener('click', () => toggleStartPause());
  btnPause.addEventListener('click', () => { if(Game.running && !Game.over) togglePause(); });
  btnRestart.addEventListener('click', () => restart());
  btnPlay.addEventListener('click', () => { ensureAudio(); start(); hideOverlay(); });

  // NEW: Speed control listeners
  function onSpeedChanged(save=true){
    const pct = clamp(Number(speedSlider.value), 50, 200);
    Game.speedFactor = pct / 100;
    uiSpeed.textContent = pct + '%';
    if(save) localStorage.setItem('oscatch_speed', Game.speedFactor.toFixed(2));
    // Smoothly reconcile spawn timing when speed changes mid-run
    if(Game.running && !Game.over){
      Game.spawnTimer = Math.min(Game.spawnTimer, Game.spawnEvery / Game.speedFactor);
    }
  }
  function adjustSpeed(deltaPct){
    const v = clamp(Number(speedSlider.value) + deltaPct, 50, 200);
    speedSlider.value = String(v);
    onSpeedChanged(true);
  }
  speedSlider.addEventListener('input', () => onSpeedChanged(false));
  speedSlider.addEventListener('change', () => onSpeedChanged(true));

  function toggleStartPause(){
    if(!Game.running){ start(); hideOverlay(); }
    else if(Game.paused){ Game.paused=false; hideOverlay(); }
    else if(!Game.over){ Game.paused=true; showOverlay(false, "Paused"); }
  }
  function togglePause(){ Game.paused = !Game.paused; Game.paused ? showOverlay(false,"Paused") : hideOverlay(); }

  function showOverlay(intro=false, title="Deploy your cloud—catch services, dodge hazards"){
    const titleEl = document.getElementById('introTitle'); if(titleEl) titleEl.textContent = title;
    overlay.classList.remove('hide'); overlay.style.display = 'flex';
    if(intro) btnPlay.classList.remove('hide'); else btnPlay.classList.add('hide');
  }
  function hideOverlay(){ overlay.classList.add('hide'); overlay.style.display = 'none'; }

  // ---------- Collision ----------
  function circleRectCollides(cx,cy,cr, rx,ry,rw,rh){
    const nx = clamp(cx, rx, rx+rw);
    const ny = clamp(cy, ry, ry+rh);
    const dx = cx - nx, dy = cy - ny;
    return (dx*dx + dy*dy) <= cr*cr;
  }

  // ---------- Game control ----------
  function resetGame(){
    Game.running=false; Game.paused=false; Game.over=false;
    Game.score=0; Game.lives=3; Game.time=0;
    Game.items.length=0; Game.particles.length=0;
    Game.spawnTimer=0; Game.spawnEvery=900; Game.speedBase=90;
    updateUI();
    resetPlayer();
  }
  function start(){ ensureAudio(); if(Game.over) resetGame(); Game.running=true; Game.paused=false; canvas.focus(); }
  function restart(){ resetGame(); start(); hideOverlay(); }
  function gameOver(){
    Game.over=true; Game.running=false; Game.paused=false;
    if(Game.score > Game.best){ Game.best = Game.score; localStorage.setItem('oscatch_best', String(Game.best)); }
    updateUI();
    showOverlay(false, "Game Over");
  }

  function updateUI(){
    uiScore.textContent = Game.score;
    uiLives.textContent = '❤'.repeat(Game.lives) + '♡'.repeat(Math.max(0,3-Game.lives));
    uiBest.textContent = Game.best;
  }

  // ---------- Loop ----------
  let last = performance.now();
  function frame(now){
    const dt = Math.min(0.033, (now-last)/1000);
    last = now;
    ctx.clearRect(0,0, Game.width(), Game.height());
    drawBackground();

    if(Game.running && !Game.paused && !Game.over){
      Game.time += dt*1000;
      Game.spawnTimer -= dt*1000;

      // Difficulty curve
      Game.spawnEvery = clamp(900 - Game.time*0.15, 350, 900);
      Game.speedBase  = clamp(90 + Game.time*0.05, 90, 340);

      if(Game.spawnTimer <= 0){
        spawnItem();
        // Adjust spawn interval by speedFactor to keep density sensible
        Game.spawnTimer = Game.spawnEvery / Game.speedFactor;
      }

      // Player movement
      const accel = Player.speed;
      if(keys.has('left')){ Player.vx = -accel; Player.targetX = null; }
      else if(keys.has('right')){ Player.vx = accel; Player.targetX = null; }
      else {
        if(Player.targetX!=null){
          const dx = (Player.targetX - Player.x);
          Player.vx = clamp(dx*6, -accel, accel);
          if(Math.abs(dx) < 4) Player.vx = 0;
        } else Player.vx = 0;
      }
      Player.x += Player.vx * dt;
      Player.x = clamp(Player.x, 4, Game.width()-Player.w-4);
    }

    // Items update & draw
    for(let i=Game.items.length-1;i>=0;i--){
      const it = Game.items[i];
      if(Game.running && !Game.paused && !Game.over){
        // Apply global speed factor to falling movement
        it.y += it.vy * dt * Game.speedFactor;
      }
      drawItem(it);

      // Collision
      if(!Game.paused && !Game.over && circleRectCollides(it.x, it.y, it.r, Player.x, Player.y, Player.w, Player.h)){
        if(it.type==='service'){
          Game.score += 10;
          beep('good');
          particleBurst(it.x, it.y, it.color, 12);
        }else{
          Game.lives -= 1;
          beep('bad');
          particleBurst(it.x, it.y, '#e53935', 18);
          if(Game.lives<=0) gameOver();
        }
        Game.items.splice(i,1);
        updateUI();
        continue;
      }

      // Remove if offscreen
      if(it.y - it.r > Game.height()){
        Game.items.splice(i,1);
      }
    }

    // Particles
    drawParticles(dt);

    // Player
    drawCloud(Player.x, Player.y, Player.w, Player.h);

    drawHUD();

    requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);

  // Start in intro mode
  resetGame();
  showOverlay(true);

  // Pause on blur
  window.addEventListener('blur', () => { if(Game.running && !Game.over) { Game.paused = true; showOverlay(false, "Paused"); } });

})();
</script>
</body>
</html>
